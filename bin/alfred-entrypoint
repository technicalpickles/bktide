#!/bin/bash

set -e
set -x

workflow_dir="$(dirname "$0")/.."
cd "$workflow_dir"

log_file="$HOME/.local/state/bktide/logs/alfred.log"
mkdir -p "$(dirname "$log_file")"

# Optionally source user-provided environment to customize PATH, NODE_BIN, etc.
xdg_config_home="${XDG_CONFIG_HOME:-$HOME/.config}"
user_env_file="$xdg_config_home/bktide/env"
workflow_env_file="$workflow_dir/.env"

if [[ -f "$user_env_file" ]]; then
  # Export variables defined in the file
  set -a
  source "$user_env_file"
  set +a
elif [[ -f "$workflow_env_file" ]]; then
  set -a
  source "$workflow_env_file"
  set +a
fi

command="$1"
shift

if [[ -z "$command" ]]; then
  echo "Usage: $0 <command> [filter]"
  exit 1
fi

if [[ -z "$NODE_BIN" ]]; then
  export NODE_BIN=node
fi

echo "Running command: $NODE_BIN $workflow_dir/dist/index.js $command" "$@" >> "$log_file"
"$NODE_BIN" "$workflow_dir/dist/index.js" "$command" --format alfred "$@" 2>&1 | tee -a "$log_file"