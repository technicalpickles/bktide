# Alfred Workflow: Development & Packaging

This document is for contributors who work on the Alfred workflow itself: how the bundle is built, what goes in it, how the wrapper works, and how to test/release changes. For installation and day-to-day usage, see the end‑user guide in `docs/alfred-installation.md`.

## How the workflow bundle is populated

The workflow bundle is generated by `scripts/package-workflow.js` and uses files in this repo as the source of truth. Run:

```bash
npm run package
```

This produces two artifacts in `pkg/`:

- `bktide-workflow-<version>.alfredworkflow`
- `bktide-workflow-<version>.alfredworkflow.sha256`

### Assets included in the bundle
- `info.plist`: Base workflow definition committed to the repo
- `icon.png` and images in `icons/`
- `bin/alfred-entrypoint` wrapper script
- Compiled CLI in `dist/`
- `package.json` and `package-lock.json`
- `env.example` and `WORKFLOW_README.md`

### Metadata injection (About tab, version, etc.)
During packaging, the script reads `package.json` and `WORKFLOW_README.md` and injects metadata into the staged `info.plist` before zipping:

- `version`: Set from `package.json.version`
- `description`: First non-empty line from `WORKFLOW_README.md` (falls back to `package.json.description`)
- `createdby`: Set from `package.json.author` (string or object)
- `webaddress`: Set from `package.json.repository.url` when available
- `readme`: Full contents of `WORKFLOW_README.md` are embedded so Alfred’s “About this Workflow” tab shows rich help
- `bundleid`: If empty, a deterministic default is generated (`com.<author>.<name>`). To pin a specific Bundle ID, set the `bundleid` key in the repo’s `info.plist`.

The modified plist is validated with `plutil -lint` when available.

## Wrapper behavior (`bin/alfred-entrypoint`)
- Always adds `--format alfred` to CLI invocations
- Writes workflow logs to Alfred’s cache directory (`$alfred_workflow_cache/alfred.log`) when available, otherwise to `~/.local/state/bktide/logs/alfred.log`
- Enables CLI debug output when `DEBUG=true|True|TRUE|1` is set in the environment

## User Configuration (Configuration Builder)
The workflow exposes the following user-configurable variable via Alfred’s Configuration Builder (stored in `info.plist` → `userconfigurationconfig`):

- `NODE_BIN` (textfield): Path to the Node.js binary to run the CLI. Defaults to `node` and can be overridden if Node isn’t on PATH.

To add more configuration in the future, extend `info.plist`’s `userconfigurationconfig` array, then read the variables in `bin/alfred-entrypoint` or the CLI.

## Icons

For better visuals, icons in `icons/` are referenced by the Script Filter outputs:
- `passed.png`, `failed.png`, `running.png`, `scheduled.png`, `skipped.png`, `blocked.png`, `failing.png`, `unknown.png`

Notes:
- Some states (e.g., canceled, canceling, not_run) are mapped to `unknown.png`.
- Error/empty states also use `unknown.png` to avoid missing icons.

## Manual Alfred setup and alternative actions (for custom workflows)
The packaged workflow is pre-configured. If creating a workflow from scratch or customizing, these are the typical connections:

### Script Filter
Set the Script Filter script to call the wrapper:

```bash
/absolute/path/to/your/project/bin/alfred-entrypoint builds --filter "$*"
```

### Alternative Actions (Builds)
- Enter (default): Open URL
  - Script Filter → Open URL
- ⌘ (Cmd): Paste URL into frontmost app
  - Script Filter → Alternative action (⌘) → Copy to Clipboard
  - Content: `{query}`
  - Enable “Automatically paste to front most app”
- ⌥ (Alt): Show build annotations in a Text View
  - Script Filter → Alternative action (⌥) → Run Script
  - Script: `bin/alfred-entrypoint annotations "$@"`
  - Connect directly to a Text View (Object Input → Preview only)

Notes:
- The Script Filter provides `{query}` as the build URL for default/⌘ actions, and a build ref `org/pipeline/number` for the ⌥ action.
- If the build ref cannot be derived for a row, the ⌥ alternative action is omitted for that item.

### Alternative Actions (Pipelines)
- Enter (default): Open URL → Open URL
- ⌘ (Cmd): Paste URL → Alternative action (⌘) → Copy to Clipboard; Content: `{query}`; Enable “Automatically paste to front most app”

## Releasing and local testing
1. `npm run package`
2. Import the generated `.alfredworkflow` into Alfred (double-click)
3. Open the workflow’s settings and verify:
   - Bundle ID is set and stable
   - About tab shows version, author, web address, and the embedded README
   - Icon renders properly
4. Exercise keywords: `bkb`, `bkp`, `bkt`, `bkts`, `bktr`

For repo-wide release steps, see `docs/releasing.md`.


