# Alfred Integration

This CLI supports integration with Alfred workflows via the `--format alfred` option, for example

```bash
bin/bktide builds --format alfred
```

This outputs builds in a JSON format that Alfred can process as a Script Filter. Each build will be shown as a result row with:

- Title: Pipeline name and build number
- Subtitle: State, branch, and commit message
- Action: Opens the build URL when clicked

## Convenience Wrapper

`bin/alfred-entrypoint` is a script that Alfred can call. It:

- uses NODE_BIN to determine what to execute
- automatically adds `--format alfred`
- calls bktide and passes `$@` to it

## Alternative Actions (Builds)

Configure Alfred alternative actions on the Script Filter connection:

- Enter (default): Open URL
  - Script Filter → Open URL
- ⌘ (Cmd): Paste URL into frontmost app
  - Script Filter → Alternative action (⌘) → Copy to Clipboard
  - Content: `{query}`
  - Enable “Automatically paste to front most app”
- ⌥ (Alt): Show build annotations in a Text View
  - Script Filter → Alternative action (⌥) → Run Script
  - Script: `bin/alfred-entrypoint annotations "$@"`
  - Connect directly to a Text View (Object Input → Preview only)

Notes:
- The Script Filter provides `{query}` as the build URL for default/⌘ actions, and a build ref `org/pipeline/number` for the ⌥ action.
- If the build ref cannot be derived for a row, the ⌥ alternative action is omitted for that item.

See Alfred docs:
- Using Alternative Actions: https://www.alfredapp.com/help/workflows/advanced/alternative-actions/
- Text View: https://www.alfredapp.com/help/workflows/user-interface/text/

## Alternative Actions (Pipelines)

Configure Alfred alternative actions for the Pipelines Script Filter similarly:

- Enter (default): Open URL
  - Script Filter → Open URL
- ⌘ (Cmd): Paste URL into frontmost app
  - Script Filter → Alternative action (⌘) → Copy to Clipboard
  - Content: `{query}`
  - Enable “Automatically paste to front most app”

Notes:
- The Pipelines Script Filter provides `{query}` as the pipeline’s web URL for all actions.

## Alfred Workflow Setup

1. Create a new Alfred workflow
2. Add a "Script Filter" trigger
3. Set the script to:
   ```bash
   /absolute/path/to/your/project/bin/alfred-entrypoint builds --filter "$*"
   ```
4. Connect it to an "Open URL" action
   - URL: `{query}`

### Token commands in Alfred

The workflow includes convenient keywords for token management:

- `bkt`: Check token status (runs `token --check`)
- `bkts`: Store/update token (prompts, then runs `token --store --token "{var:token}"`)
- `bktr`: Reset token (runs `token --reset`)

## Icons

For better visuals, these icons are available in the `icons/` directory:
- `passed.png`
- `failed.png`
- `running.png`
- `scheduled.png`
- `skipped.png`
- `blocked.png`
- `failing.png`
- `unknown.png`

Notes:
- Some states (e.g., canceled, canceling, not_run) are mapped to `unknown.png`.
- Error/empty states also use `unknown.png` to avoid missing icons.

## How the workflow bundle is populated

This repo builds a ready-to-package Alfred workflow. The bundle is generated by `scripts/package-workflow.js` and uses files in this repo as the source of truth. Run:

```bash
npm run package
```

This produces two artifacts in `pkg/`:

- `bktide-workflow-<version>.alfredworkflow`
- `bktide-workflow-<version>.alfredworkflow.sha256`

### Assets included in the bundle
- `info.plist`: Base workflow definition committed to the repo
- `icon.png` and images in `icons/`
- `bin/alfred-entrypoint` wrapper script
- Compiled CLI in `dist/`
- `package.json` and `package-lock.json`
- `env.example` and `WORKFLOW_README.md`

### Metadata injection (About tab, version, etc.)
During packaging, the script reads `package.json` and `WORKFLOW_README.md` and injects metadata into the staged `info.plist` before zipping:

- `version`: Set from `package.json.version`
- `description`: First non-empty line from `WORKFLOW_README.md` (falls back to `package.json.description`)
- `createdby`: Set from `package.json.author` (string or object)
- `webaddress`: Set from `package.json.repository.url` when available
- `readme`: Full contents of `WORKFLOW_README.md` are embedded so Alfred’s “About this Workflow” tab shows rich help
- `bundleid`: If empty, a deterministic default is generated (`com.<author>.<name>`). To pin a specific Bundle ID, set the `bundleid` key in the repo’s `info.plist`.

The modified plist is validated with `plutil -lint` when available.

### Wrapper behavior (`bin/alfred-entrypoint`)
- Always adds `--format alfred` to CLI invocations
- Writes workflow logs to Alfred’s cache directory (`$alfred_workflow_cache/alfred.log`) when available, otherwise to `~/.local/state/bktide/logs/alfred.log`
- Enables CLI debug output when `DEBUG=true|True|TRUE|1` is set in the environment

### User Configuration (Configuration Builder)
The workflow exposes the following user-configurable variable via Alfred’s Configuration Builder (stored in `info.plist` → `userconfigurationconfig`):

- `NODE_BIN` (textfield): Path to the Node.js binary to run the CLI. Defaults to `node` and can be overridden if Node isn’t on PATH.

To add more configuration in the future, extend `info.plist`’s `userconfigurationconfig` array, then read the variables in `bin/alfred-entrypoint` or the CLI.

### Releasing and testing
1. `npm run package`
2. Import the generated `.alfredworkflow` into Alfred (double-click)
3. Open the workflow’s settings and check:
   - Bundle ID is set and stable
   - About tab shows version, author, web address, and the embedded README
   - Icon renders properly
4. Exercise keywords: `bkb`, `bkp`, `bkt`, `bkts`, `bktr`

For Alfred-specific guidance on sharing and configuration, see the official docs: [Sharing workflows](https://www.alfredapp.com/help/workflows/advanced/sharing-workflows/) and [Workflow configuration](https://www.alfredapp.com/help/workflows/workflow-configuration/).